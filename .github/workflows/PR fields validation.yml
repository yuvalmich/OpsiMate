name: PR Fields Validation

# This workflow validates that pull requests have meaningful titles and descriptions
# Requirements:
# 1. PR title should contain feat/Feat/FEAT or bug/BUG/Bug (case-insensitive)
# 2. PR should have a description/body with meaningful content
# 3. Title should be descriptive

on:
  pull_request:
    types: [opened, edited, synchronize]

jobs:
  validate-pr-title:
    name: Validate PR Title
    runs-on: ubuntu-latest

    steps:
      - name: Check PR Description
        id: check-description
        env:
          PR_BODY: ${{ github.event.pull_request.body }}
        run: |
          # Check if PR body exists and has meaningful content
          BODY="$PR_BODY"

          # Remove whitespace and check if empty
          CLEANED_BODY=$(echo "$BODY" | tr -d '[:space:]')

          if [ -z "$CLEANED_BODY" ] || [ "$CLEANED_BODY" = "null" ]; then
            echo "⚠️  PR Description is missing!"
            echo ""
            echo "Consider adding a description to help reviewers understand your changes."
            echo "This is optional but recommended."
            echo "description_valid=false" >> $GITHUB_OUTPUT
          else
            # Check for minimum description length
            WORD_COUNT=$(echo "$BODY" | wc -w)

            if [ "$WORD_COUNT" -lt 3 ]; then
              echo "⚠️  PR Description is very short!"
              echo "Consider adding more details to help reviewers."
              echo "description_valid=false" >> $GITHUB_OUTPUT
            else
              echo "✅ PR Description looks good!"
              echo "description_valid=true" >> $GITHUB_OUTPUT
            fi
          fi

      - name: Custom Title Validation
        env:
          PR_TITLE: ${{ github.event.pull_request.title }}
        run: |
          TITLE="$PR_TITLE"

          echo "Checking PR title: $TITLE"

          # Convert to uppercase for case-insensitive matching
          TITLE_UPPER=$(echo "$TITLE" | tr '[:lower:]' '[:upper:]')

          # Check if title contains feat, bug, fix, chore, or other common prefixes (case-insensitive)
          if [[ "$TITLE_UPPER" =~ (FEAT|BUG|FIX|CHORE|REFACTOR|DOCS|STYLE|TEST|PERF|CI|BUILD|REVERT|MERGE) ]]; then
            echo "✅ Title contains valid prefix!"
          else
            # Check if title looks reasonable (has some descriptive content)
            if [ ${#TITLE} -ge 10 ]; then
              echo "✅ Title looks reasonable (has descriptive content)"
            else
              echo "⚠️  Title might be too short or missing a prefix"
              echo ""
              echo "Consider using prefixes like: feat, bug, fix, chore, refactor, etc."
              echo "Examples:"
              echo "• feat: Add dark mode toggle"
              echo "• bug: Fix login redirect issue"
              echo "• fix: Resolve dashboard loading error"
              echo ""
              echo "Current title: \"$TITLE\""
              echo "This is a warning, not a blocker."
            fi
          fi

          # Check title length (soft check)
          if [ ${#TITLE} -lt 5 ]; then
            echo "⚠️  Title is very short - consider making it more descriptive"
          else
            echo "✅ Title length is acceptable"
          fi

          echo "✅ PR title validation completed!"
